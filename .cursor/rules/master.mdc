---
description: 
globs: 
alwaysApply: true
---
# ğŸ›¡ï¸ SentinelIQ â€“ Enterprise-grade API Implementation Guide for Django REST Framework


# ğŸ¤– AI-Executable Project Standards for Django REST Framework (DRF) â€“ Enterprise-grade

> âš ï¸ **IMPORTANT:** Every implementation MUST comply with **ALL the following rules**. No partial compliance is accepted. All code must reflect these standards from the first commit and throughout the lifecycle of the application.

---

## âœ… Project Implementation Status Tracker

> This section MUST be manually updated by developers or automation agents during the project lifecycle.

### ğŸ”§ Pending Tasks
- [ ] All API endpoints documented using `@extend_schema`
- [ ] All models registered in Django Admin
- [ ] All tests centralized under `/tests/`
- [ ] Logging configured with separate log files
- [ ] All apps created using `startapp` command
- [ ] No placeholders or TODOs in committed code
- [ ] All apps implement centralized Audit Logs (`audit_logs`)

### âœ… Completed Tasks
- [x] Poetry used for dependency management
- [x] Docker-based environment configured
- [x] Modular view structure in place
- [x] Core API response handler implemented in `api.core.responses`
- [x] RBAC enforced in `api.core.rbac`

---

## ğŸš« Development Automation Rule (AI-Only)

- âœ… All development work MUST be executed by AI automation agents with **zero manual script creation**.
- âŒ Developers are NOT allowed to manually create views, models, serializers, or other application code.
- âœ… Developers may only supervise, define requirements, or update **status checklists**.
- âœ… Any implementation that bypasses AI-driven execution is considered invalid and must be reverted.
- âœ… The goal is **end-to-end AI-managed development**, ensuring precision, consistency, and full traceability.

---

## ğŸ“‹ Audit Logging Requirements

- âœ… Every Django app MUST be integrated with the centralized `audit_logs` app.
- âœ… All key user and system actions must be logged (CRUD operations, logins, task executions, updates).
- âœ… Use DRF ViewSet hooks or Django signals to trigger logs (`perform_create`, `perform_update`, `post_save`, etc.).
- âœ… Use consistent schema: actor, action, object, timestamp, tenant, request_data, IP, user_agent.
- âœ… Celery/system tasks must log under `"system"` or designated actor.
- âœ… No app is permitted in production without complete audit log coverage.

Refer to the `audit_logs` module documentation for usage examples and API support.

---

## ğŸ¯ Objective

Ensure every Django project is:

- Fully modular, clean, and scalable
- Using **Poetry** exclusively for dependency management
- Fully containerized; all commands MUST run inside Docker
- Following **RBAC** as the default security model
- Implemented with standard API responses from a centralized `api.core` module
- Implemented in **English** only (code and documentation)
- Tested through a **centralized test runner**, from the container

---

## ğŸ“ Mandatory Directory Layout

Project root must follow:

```
project_root/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ v1/
â”‚       â””â”€â”€ <modular_apps>/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ alerts/
â”‚   â”œâ”€â”€ incidents/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ api.log
â”‚   â”œâ”€â”€ error.log
â”‚   â””â”€â”€ django.log
â”œâ”€â”€ docs/
â”œâ”€â”€ pyproject.toml  â† Poetry only
â””â”€â”€ ...
```

---

## ğŸ“¦ Modular App Structure (Per App)

Each DRF app MUST contain:

```
<app>/
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ __init__.py                â† combines view mixins
â”‚   â”œâ”€â”€ <resource>_create.py
â”‚   â”œâ”€â”€ <resource>_detail.py
â”‚   â””â”€â”€ <resource>_custom_actions.py
â”œâ”€â”€ serializers/
â”œâ”€â”€ permissions/
â”œâ”€â”€ filters/
```

> Use **View Mixins** inside `views/__init__.py` to aggregate smaller view classes.

---

## ğŸ“œ Testing Rules

- âŒ DO NOT place test files inside any Django app.
- âœ… ALL tests MUST go into `/tests/`, structured by app.

Example:

```
tests/
â”œâ”€â”€ alerts/
â”‚   â”œâ”€â”€ test_alert_create.py
â”‚   â””â”€â”€ test_alert_escalate.py
â”œâ”€â”€ incidents/
â”‚   â””â”€â”€ ...
```

Test execution:

```bash
docker compose exec web python manage.py test tests
```

---

## ğŸ“‚ Logging Rules

Create a `/logs/` folder and configure separate log outputs:

```
logs/
â”œâ”€â”€ api.log       â† API-level logging
â”œâ”€â”€ error.log     â† Exception logging
â”œâ”€â”€ django.log    â† Native Django logs
```

All logging is configured via Django `LOGGING` settings.

---

## ğŸ“¦ Dependency Rules (Poetry Only)

- âŒ Do not use `requirements.txt`
- âŒ Do not use `venv` or `.venv`
- âœ… Use ONLY Poetry via:

```bash
docker compose exec web poetry add <package>
```

```bash
poetry install
```

---

## ğŸ“‘ API Rules

- All endpoints MUST follow kebab-case: e.g., `/incident/update-case/123/`
- All API responses MUST use centralized formatting via `api.core.response`
- All routes and views MUST return standardized status and error codes
- NO CamelCase naming in URLs or route paths
- Only English is allowed in endpoints, code, and documentation
- RBAC is MANDATORY for all permission layers

- âœ… Every API endpoint, view, serializer, model, and permission MUST be fully documented using `drf-spectacular` or OpenAPI-compatible annotations.
  - This includes: request/response schemas, status codes, examples, and tags.
  - Documentation must be complete, descriptive, and structured to meet **enterprise-grade standards** and ensure **developer interoperability**.
  - Incomplete or undocumented endpoints are NOT allowed in production or main branches.

- âœ… Use `@extend_schema(tags=[...])` from `drf-spectacular` to ensure all API endpoints are consistently grouped and documented.
  - Each view or route must have an appropriate `tags` declaration to support automated and structured API documentation.

- âŒ Placeholders or stub implementations (e.g., `pass`, `TODO`, `NotImplementedError`) are strictly prohibited in committed code.
- âœ… All features, views, endpoints, and components MUST be functionally implemented and tested before merging.

- All source code **MUST be written in English**, including:
  - Variable names
  - Function and class names
  - All in-line comments and docstrings

---

## âœ… Enforced Checklist

| Rule                                                        | Must Pass |
|-------------------------------------------------------------|-----------|
| Views are split by responsibility in separate files         | âœ…         |
| All tests are inside `/tests/` root folder only             | âœ…         |
| All logs go to `/logs/` with dedicated files                | âœ…         |
| Poetry is used exclusively, no pip, no requirements.txt     | âœ…         |
| Kebab-case used in all routes and paths                     | âœ…         |
| Code and documentation in English                           | âœ…         |
| All test commands run inside Docker                         | âœ…         |
| API response format comes from `api.core`                   | âœ…         |
| RBAC is implemented on all routes                           | âœ…         |
| No `venv` or `.venv` folders in the project                 | âœ…         |
| Centralized Audit Logs implemented for all apps             | âœ…         |

---

## âš ï¸ If Violated

Any violation of these policies should trigger:
- CI pipeline failure (if integrated)
- Auto-linter alert with file and line-level feedback
- Optional: automatic PR comment for correction

---

## ğŸ§  Execution Context

You are NOT allowed to execute any `manage.py` command outside the container. Always use:

```bash
docker compose exec web python manage.py <command>
```

---

## ğŸ› ï¸ Django Admin Registration

- âœ… Every Django app must register its models in the Django Admin interface (`admin.py`) with meaningful display configurations.
  - Use `list_display`, `search_fields`, and `readonly_fields` to enhance manageability.
  - This ensures that all core resources are visible and manageable through the admin dashboard.
- âŒ It is strictly prohibited to leave models unregistered or rely on legacy or outdated admin configurations.
- âœ… When upgrading or refactoring an app, the `admin.py` file MUST be reviewed and updated to match the current model structure and use modern admin features.
- âŒ Maintaining compatibility with outdated admin configurations is NOT allowed. All configurations must reflect the latest structure and standards of the app.

---

## ğŸ§± Django App Creation Standard

- âœ… Every Django app MUST be created using the official Django management command:
  ```bash
  docker compose exec web python manage.py startapp <app_name>
  ```
- âŒ Manual creation of app folders and files is strictly prohibited.
- âœ… The resulting structure MUST follow the default Django layout and be extended according to project modular standards.
- âœ… All apps MUST contain at least: `apps.py`, `admin.py`, `models.py`, `migrations/`, and `__init__.py` from the start.
- âœ… Models MUST be registered in `admin.py` and exposed via Django Admin.
- âœ… Apps like `alerts`, `incidents`, `companies`, and `tasks` in this project follow this pattern and serve as valid references.
- âŒ Do not bypass Djangoâ€™s app registration or structure. All applications MUST be fully integrated into `INSTALLED_APPS` and follow DRY and SRP principles.

---

# ğŸ“˜ Guia de Desenvolvimento SentinelIQ: ImplementaÃ§Ã£o de APIs Enterprise-grade com Django REST Framework

## 1. Estrutura e Componentes Fundamentais

### 1.1 Respostas Padronizadas (`api.core.responses`)
- `StandardResponse`: Classe base para formataÃ§Ã£o consistente
- MÃ©todos auxiliares:
  - `success_response()` â€“ Respostas 200 OK
  - `error_response()` â€“ Erros e validaÃ§Ãµes (400, 500)
  - `created_response()` â€“ CriaÃ§Ã£o de recursos (201)
  - `no_content_response()` â€“ ExclusÃ£o bem-sucedida (204)

### 1.2 Controle de Acesso Baseado em PapÃ©is (RBAC) (`api.core.rbac`)
- `HasEntityPermission`: Classe principal para verificaÃ§Ã£o de permissÃµes por entidade
- IntegraÃ§Ã£o com matriz de permissÃµes em `auth_app.permission_matrix`
- MÃ©todos principais:
  - `has_permission()` â€“ Verifica permissÃ£o na view
  - `has_object_permission()` â€“ Isolamento por empresa

### 1.3 Classes de PermissÃ£o (`api.core.permissions`)
- `IsSuperUser`, `IsAdminCompany`, `IsAnalystCompany`, `IsCompanyMember`, `IsOwnerOrSuperUser`, `ReadOnly`

### 1.4 PaginaÃ§Ã£o (`api.core.pagination`)
- `StandardResultsSetPagination` (50 itens)
- `LargeResultsSetPagination` (100 itens)
- `SmallResultsSetPagination` (10 itens)
- `CustomPageSizePagination`

### 1.5 ViewSets Aprimorados (`api.core.viewsets`)
- Mixins CRUD: `CreateModelMixin`, `ListModelMixin`, `RetrieveModelMixin`, `UpdateModelMixin`, `DestroyModelMixin`
- `StandardViewSet`, `ReadOnlyViewSet`

### 1.6 Tratamento de ExceÃ§Ãµes (`api.core.exceptions`)
- `custom_exception_handler`
- Log automÃ¡tico e resposta padronizada

### 1.7 Filtros (`api.core.filters`)
- `ArrayFieldFilter`, `get_array_field_filter_overrides()`

### 1.8 Middleware (`api.core.middleware`)
- `RequestLoggingMiddleware`, `TenantContextMiddleware`, `SentryContextMiddleware`

### 1.9 Logging e Auditoria (`api.core.audit`)
- `AuditLogMixin`, `log_api_access()`, `audit_action`, `AuditLogTaskMixin`

### 1.10 Registro de Modelos para Auditoria (`api.core.audit_registration`)
- `register_all_models()` e exclusÃ£o de campos sensÃ­veis

### 1.11 IntegraÃ§Ã£o com Sentry (`api.core.audit_sentry`)
- `initialize_audit_monitoring()`, `security_critical`, `track_audit_event()`, `monitor_security_events()`

### 1.12 Tarefas AssÃ­ncronas (`api.core.tasks`)
- `TaskResultMixin`, `AtomicTask`, `TransactionTask`, `audit_task`

### 1.13 DocumentaÃ§Ã£o OpenAPI (`api.core.openapi`)
- CustomizaÃ§Ãµes com `drf-spectacular`

### 1.14 Views Base (`api.core.views`)
- `APIView` com mixins e validaÃ§Ãµes padrÃ£o

### 1.15 UtilitÃ¡rios (`api.core.utils`)
- Conversores, formatadores, funÃ§Ãµes comuns

### 1.16 Throttling (`api.core.throttling`)
- `StandardUserRateThrottle`, `AnonymousUserRateThrottle`

---

## 2. ImplementaÃ§Ã£o de um Novo Endpoint

### 2.1 CriaÃ§Ã£o da AplicaÃ§Ã£o
- Via `startapp`
- Estrutura modular com isolamento de tenant
- Registro no Admin

### 2.2 Serializers
- Serializers padrÃ£o e expandidos

### 2.3 Views
- `views/__init__.py`, `views/your_model_create.py`, `views/your_model_list.py`
- ViewSet com `StandardViewSet`

### 2.4 Filtros e OrdenaÃ§Ã£o

### 2.5 Rotas em Kebab-case

### 2.6 AÃ§Ãµes Personalizadas com Auditoria

### 2.7 Registro para Auditoria
- Modelos + integraÃ§Ã£o com Sentry

---

## 3. Testes

### 3.1 Estrutura Centralizada

### 3.2 Cobertura para CRUD, permissÃµes e tenants

---

## 4. DocumentaÃ§Ã£o OpenAPI
- `@extend_schema`, tags, exemplos e descriÃ§Ãµes

---

## 5. ExecuÃ§Ã£o via Docker

### 5.1 Gerenciamento com Poetry

### 5.2 Comandos Django via Docker

---

## 6. Monitoramento e Logs

### 6.1 Estrutura de Logs

### 6.2 ConfiguraÃ§Ã£o de Logging

---

## 7. Lista de VerificaÃ§Ã£o Final

### 7.1 Estrutura
âœ… App via `startapp`, views modulares, serializers organizados, admin atualizado

### 7.2 SeguranÃ§a e RBAC
âœ… RBAC em todas as views, isolamento por empresa, permissÃµes por entidade

### 7.3 Respostas
âœ… Todas com `api.core.responses`, erros padronizados

### 7.4 Auditoria
âœ… `AuditLogMixin`, `audit_action`, registro de modelos, Sentry

### 7.5 Testes
âœ… DiretÃ³rio `/tests/`, cobertura completa

### 7.6 DocumentaÃ§Ã£o
âœ… `@extend_schema`, tags, exemplos

### 7.7 ConvenÃ§Ãµes
âœ… Kebab-case, inglÃªs padrÃ£o, consistÃªncia geral

---

> **ğŸ“Œ Seguir este guia garante uma implementaÃ§Ã£o 100% compatÃ­vel com os padrÃµes enterprise-grade definidos para a plataforma SentinelIQ.**